{{!< layout/default}}


{{#extend "css"}}
<style>
	.select2-dropdown {
  		z-index: 999999;
	}
</style>
{{/extend}}

    <div id="divLoading"></div>

	<div id="container" style="position:relative;">
		<a class="menu-btn btn btn-default" style="position: fixed; z-index:3;">
			<i class="fa fa-3x fa-bars" aria-hidden="true"></i>
		</a>

		<div id="map-container">
			<div style="position:fixed; top:0; right:0; z-index:2;">
				<span style="margin-right:-5px;"><input id="searchDirection" placeholder="Buscar dirección" type="text" class"form-control box-shadows"></span>
				<span><a id="searchDirectionButton" class="btn btn-default"><i class="fa fa-search" aria-hidden="true"></i></a></span>
			</div>
			<center><div id="patentSelected" class="box-shadows" style="visibility:hidden; z-index:2; position:fixed; left:50%; right:50%; top:0; height: 40px; width:150px; margin-left:-100px; background: white; border-radius:3px; margin-top:40px;"></div></center>
			<div id="map" style="width: 100%; height: 100%"></div>
		</div>
		<!--
		<button id="toolsMenuButton" style="right:0px; bottom:0px; position:fixed; z-index:3;">
			<i class="fa fa-angle-double-up fa-4x" aria-hidden="true"></i>
		</button>
		-->
		
		<div style="background:#353536; position:absolute; width:100%;" id="toolsMenu"></div>
		
	</div>

{{#extend "js"}}
<script>
var map;
var selectedPatent = '';
var locks = '';
var selectedLockStatus = '';
var chartSpeed;
var centered = 0;
var toolsMenu = 0;
var showingPatent = 0;
var trucksData = []; // los datos actuales del camión. ej: { lat: 123, lng: 123, patent: XD123, ... }
var markersAdd = []; // Las patentes. ej: ["ER1313", "JP4467", "GE1313", ...]
var markersObj = []; // el objeto de cada marcador agregado
var allLockStatus = []; // Todos los datos de los de las cerraduras
var allPatentsSearch = []; // Los objetos de las patentes para el buscador de patente. ej: [{i: 1, text: "ER1313"}, {i:2, text: "GE1313"}, ...]
var allGeozones = []; // Todas las geozonas con sus datos
var geozonesAdd = []; // Las geozonas. ej: ["alameda1", "alameda2", "alameda3", ...]
var allGeozonesSearch = []; 
var objectsToRemove = []; // Objetos del mapa a remover
var screenWidth;
var screenHeight;

/*
	Variables para la creación de geozonas
*/
var creatingGeoZone = 0;
var creatingGeoPoints = []

$(document).ready(function() {
	$("div#divLoading").addClass('show');
	
	screenWidth = $(window).width();
	screenHeight = $(window).height();
	$("#map-container").css('height', screenHeight)// - 150) 
	//loadToolsMenu();
	
	
	map = new GMaps({
		el: '#map',
		zoom: 5,
		lat: -34.987030702,
		lng: -71.237583160,
		streetViewControl: false,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		mapTypeControl: true,
		mapTypeControlOptions: {
			style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
			position: google.maps.ControlPosition.LEFT_BOTTOM
		},
		zoomControl: true,
		fullscreenControl: false,
		zoomControlOptions: {
			position: google.maps.ControlPosition.LEFT_BOTTOM
		},
		mousemove: function(e) {
			//console.log(e.latLng.lat().toFixed(9));
			//console.log(e.latLng.lng().toFixed(9));
		},
		click: function(e) { 
			createGeoPoint(e.latLng.lat().toFixed(9), e.latLng.lng().toFixed(9))
		}
	});

	/* 
		Buscador de direcciones google
	*/
	var input = document.getElementById('searchDirection');
	var autocomplete = new google.maps.places.Autocomplete(input);

	map.addControl({
		position: 'right_bottom',
		content: `<button id="toolsMenuButton" onclick="toolsMenuFunc()">
					<i class="fa fa-angle-double-up fa-4x" aria-hidden="true"></i>
					</button>`,
		style: {
			marginBottom: '0px',
			padding: '1px 6px',
			fontSize: '20px',
			fontFamily: 'Passion One,cursive'
		},
		events: {
			/*
			click: function(){
			console.log(this);
			}
			*/
		}
	});

	map.addControl({
		position: 'right_bottom',
		content: 'BLACKBOX',
		id: "socketStatus",
		style: {
			padding: '1px 6px',
			fontSize: '20px',
			fontFamily: 'Passion One,cursive'
		},
		events: {
			/*
			click: function(){
			console.log(this);
			}
			*/
		}
	});

	//var socket = io('http://localhost:1313');
	var socket = io('http://192.168.1.34:1313');

	/*
		estado de conexión al socket   INICIO
	*/
	setTimeout(function() {
		if (socket.connected) {
			$('#socketStatus').css('color', 'green');
		} else { 
			$('#socketStatus').css('color', 'red');
		}
	}, 3000);
	
	socket.on('disconnect', function(){
		$('#socketStatus').css('color', 'red');
	});
	socket.on('connect', function(){
		$('#socketStatus').css('color', 'green');
	});

	/*
		Socket Geozones
	*/
	socket.on('geozones', function(data) {
		data.forEach(function(element, index) {
			if ((geozonesAdd.indexOf(element.name) == -1)) {
				var geo = map.drawPolygon({
					id: element.name,
					paths: element.poly,
					strokeColor: element.geoColor,
					strokeOpacity: 1,
					strokeWeight: 3,
					fillColor: element.geoColor,
					fillOpacity: 0.6,
					mousemove: function(e) {
						//console.log(e.latLng.lat().toFixed(9));
						//console.log(e.latLng.lng().toFixed(9));
						if ( showingPatent == 0 ) {
							showingPatent = 1;
							map.addControl({
								position: 'bottom_center',
								content: this.id,
								id: 'geozoneShowName',
								style: {
									padding: '8px',
									fontSize: '40px',
									fontFamily: 'Passion One,cursive',
									backgroundColor: 'rgba(26, 188, 156, 0.5)'
								}
							});
						}
						
					},
					mouseout: function() {
						if ( showingPatent == 1 ) {
							showingPatent = 0;
							removeControl('geozoneShowName');
						}
					},
					click: function(e) {
						selectGeozone(this.id, this)
					}
				});

				allGeozones[element.name] = {
					id: element.id,
					geoType: element.geoType,
					geoColor: element.geoColor,
					patents: element.patents,
					poly: element.poly,
					center: [geo.getBounds().getCenter().lat(), geo.getBounds().getCenter().lng()]
				}
				geozonesAdd.push(element.name)

				allGeozonesSearch.push({id: index, text: element.name});
			}
		});

		/* 
			Buscador de geozonas
		*/
		$("#search-geozone").select2({
			allowClear: true,
			placeholder: "Seleccione una geozona",
			data: allGeozonesSearch
		});

	});

	/*
		Socket Locks
	*/
	socket.on('locks', function(data){
		allLockStatus = data;
		getAllLockStatus();
	})

	/*
		Socket GPS
	*/

	socket.on('gps', function(data){
		if ($("div#divLoading").hasClass('show')) {
			$("div#divLoading").removeClass('show');
		}

		data.forEach(function(element, index) {

			// Si la patente seleccionada es igual al elemento en bucle
			if (selectedPatent == element.patent) {
				var point = chartSpeed.series[0].points[0];
				var speed = element.speed;
				point.update(speed);


				var dYear = moment(element.time).format('YYYY');
				var dMonth = moment(element.time).format('MMMM');
				var dDay = moment(element.time).format('DD');
				var dDayString = moment(element.time).format('dddd');
				var dHour = moment(element.time).format('HH');
				var dMinute = moment(element.time).format('mm');
				var dSecond = moment(element.time).format('ss');
				$('#latestDate').html(`
					<center>
						<p>Último registro</p>
						<hr style="border-top: 1px solid #16a085; margin-top:-10px;"/>	
						<div style="margin-top: -20px;">
							<h4 style="margin-top: -18px;">${dDayString}</h4>
							<h2 style="margin-top: -18px;">${dDay}</h2>	
							<h4 style="margin-top: -15px;">${dMonth}</h4>
							<h4 style="margin-top: -15px;">${dYear}</h4>
							<p style="margin-top: -15px;">${dHour}:${dMinute}:${dSecond}</p>
						</div>
					</center>	
				`);
			}
			
			/* 
				Si la patente no existe en markersAdd, añade un marcador en las coordenadas correspondientes 
				(y inserta el objeto de cada marcador en el arreglo markersObj), luego añade la patente a markersAdd.

				En caso que si exista en markersAdd, se cambian sus coordenadas a las nuevas en el mapa.
			*/

			if((markersAdd.indexOf(element.patent) == -1)) { 
				markersObj[element.patent] = map.addMarker({
					lat: element.lat,
					lng: element.lng,
					icon: changeIcon('black', element.track),
					optimized: false,
					animation: google.maps.Animation.DROP,
					infoWindow: {
						content: "<b>" + element.patent + "</b>"
					},
					mouseover: function() {
						this.infoWindow.open(this.map, this);
					},
					click: function() {
						selectTruck(this, element);
					}
				});

				markersObj[element.patent].infoWindow.open(markersObj[element.patent].map, markersObj[element.patent]);
				markersAdd.push(element.patent);


				/* 
					Buscador de patentes 
				*/
				allPatentsSearch.push({id: index, text: element.patent});

				$("#search-patent").select2({
					allowClear: true,
					placeholder: "Seleccione una patente",
					data: allPatentsSearch
				});
				
			} else {

				/*
					En caso que la fecha y hora del nuevo registro sea igual al anterior,
					cambiar el color del marcador a rojo. En caso contrario, cambiar el color a verde. 
				*/

				if (element.time == trucksData[element.patent].time) { // no hay nuevo registro
					if ( selectedPatent != '' && selectedPatent == element.patent ) {
						$('#patentSelected').css('color', 'red');
						$('#patentSelected').removeClass('box-shadows');
						$('#patentSelected').addClass('box-shadows-red');

						setTimeout(function() {
							$('#patentSelected').css('color', 'black');
							$('#patentSelected').removeClass('box-shadows-red');
							$('#patentSelected').addClass('box-shadows');
						}, 2000);
					}

					/*
						Cambia el color a rojo y 2 segundos despues vuelve a negro.
					*/
					markersObj[element.patent].setIcon( changeIcon('red', element.track) );
					setTimeout(function() {
						markersObj[element.patent].setIcon( changeIcon('black', element.track) );
					}, 2000);

				} else { // hay nuevo registro
					if ( selectedPatent != '' && selectedPatent == element.patent ) {
						$('#patentSelected').css('color', 'green');
						$('#patentSelected').removeClass('box-shadows');
						$('#patentSelected').addClass('box-shadows-green');

						setTimeout(function() {
							$('#patentSelected').css('color', 'black');
							$('#patentSelected').removeClass('box-shadows-green');
							$('#patentSelected').addClass('box-shadows');
						}, 2000);
					}

					/*
						Cambia el color a verde y 2 segundos despues vuelve a negro.
					*/
					markersObj[element.patent].setIcon( changeIcon('green', element.track) );
					setTimeout(function() {
						markersObj[element.patent].setIcon( changeIcon('black', element.track) );
					}, 2000);
				}

				var latlng = new google.maps.LatLng(element.lat, element.lng);
				markersObj[element.patent].setPosition(latlng);
			}

			if(centered == 1) {
				centerZoom(trucksData[selectedPatent].lat, trucksData[selectedPatent].lng);	
			}
			

			/*
				Asignamos los datos de cada patente a un arreglo (en caso que ya exista se reemplaza).
			*/
			trucksData[element.patent] = element;
		});

	})
	
});

/*
	Agregar nueva geozona a base de datos
*/
function createGeoZone(name, type, path) {
    var geoPath = path;
    var geoPathToString = JSON.stringify(geoPath);

    $.ajax({
		url: '/api/geozones/newGeo',
		type: 'POST',
		data: { name: name, geoType: type, path: geoPathToString }
	})
	.done(function(data) {
		if( data.error ) {
			toastr.warning(data.error);
		} else {
			
			var geo = map.drawPolygon({
				id: data.nombre,
				paths: data.poligono,
				strokeColor: 'rgba(26, 188, 156, 0.5)',
				strokeOpacity: 1,
				strokeWeight: 3,
				fillColor: 'rgba(26, 188, 156, 0.9)',
				fillOpacity: 0.6,
				mousemove: function(e) {
					//console.log(e.latLng.lat().toFixed(9));
					//console.log(e.latLng.lng().toFixed(9));
					if ( showingPatent == 0 ) {
						showingPatent = 1;
						map.addControl({
							position: 'bottom_center',
							content: this.id,
							id: 'geozoneShowName',
							style: {
								padding: '8px',
								fontSize: '40px',
								fontFamily: 'Passion One,cursive',
								backgroundColor: 'rgba(26, 188, 156, 0.5)'
							}
						});
					}
					
				},
				mouseout: function() {
					if ( showingPatent == 1 ) {
						showingPatent = 0;
						removeControl('geozoneShowName');
					}
				},
				click: function(e) { 
					selectGeozone(this.id, this)
				}
			});
			
			toastr.success('Geozona '+ data.nombre +' creada correctamente.');

			allGeozones[data.nombre] = {
				id: data.id,
				geoType: data.geoType,
				geoColor: data.geoColor,
				patents: data.patents,
				poly: data.poly,
				center: [geo.getBounds().getCenter().lat(), geo.getBounds().getCenter().lng()]
			}
							
			$('#createGeoZone').css('color', '#333333');
			geozonesAdd.push(data.nombre)
			creatingGeoZone = 0;
			creatingGeoPoints = [];
			map.setOptions({styles: style2});
			removeControl('controlCreatingGeoZone');
			mapObjectsRemover(objectsToRemove);

			allGeozonesSearch.push({id: allGeozonesSearch.length, text: data.nombre});	
			
			$("#search-geozone").select2({
				allowClear: true,
				placeholder: "Seleccione una geozona",
				data: allGeozonesSearch
			});

		}

	})
	.fail(function() {
		console.log("error in newgeozone");
	});
}

function getAllLockStatus() {
	if ( toolsMenu == 1 ) {
		locks = '';

		allLockStatus.forEach(function(element, index) {

			if (selectedPatent == element.patent) {
				if( element.status == 0 ) {

					selectedLockStatus = `
						<center>
							<a style="width:100%; height:150px;" class="btn btn-danger"> 
								<p style="color:#222222">Estado de la</p>
								<p style="color:#222222; margin-top:-15px;">cerradura</p>
								<i class="fa fa-unlock fa-4x" style="color:#2c3e50" aria-hidden="true"></i>
							</a>
						</center>
					`;						

					$('#securityLockStatus').html(selectedLockStatus);
				} else {

					selectedLockStatus = `
						<center>
							<a style="width:100%; height:150px;" class="btn btn-success">
								<p style="color:#222222">Estado de la</p>
								<p style="color:#222222; margin-top:-15px;">cerradura</p>
								<i class="fa fa-lock fa-4x" style="color:#2c3e50" aria-hidden="true"></i>
							</a>
						</center>
					`;

					$('#securityLockStatus').html(selectedLockStatus);
				}
			}

			var lockStatus = '';
			var tooltipClass = '';
			if( element.status == 0 ) {
				lockStatus = '<i style="color: #e74c3c" class="fa fa-unlock" aria-hidden="true"></i>';
				tooltipClass = 'red-tooltip'
			} else {
				lockStatus = '<i style="color: #1abc9c" class="fa fa-lock" aria-hidden="true"></i>';
				tooltipClass = 'green-tooltip'
			}

			locks += `<span class="${tooltipClass}" data-toggle="tooltip" data-placement="top" title="${ moment(element.time).format('DD/MM/YYYY HH:mm:ss ') }" style="margin:2px; padding:2px; color:#bdc3c7; border:1px solid #bdc3c7; border-radius:5px;"> ${element.patent}: ${lockStatus}</span>`
		});

		$('#allLockStatus').html(locks)
	}
	$('[data-toggle="tooltip"]').tooltip()
}

function selectTruck(truckObj, truckData) {
	selectedPatent = truckData.patent;
	selectedLockStatus = '';
	loadToolsMenu();
	$('.inPatentSelectionOnly').css('visibility', 'visible');
	$('.nav-tabs a[href="#truckTools"]').tab('show');
	//resizeMapContainer();

	var point = chartSpeed.series[0].points[0];
	point.update(truckData.speed);

	console.log(truckData);
	

	centerZoom(truckData.lat, truckData.lng, 17)
	$('#patentSelected').css('visibility', 'visible');
	$('#patentSelected').html(`
		<h2 style="margin-top:2px;">${truckData.patent}</h2>
	`)
}

function createGeoPoint(lat, lng) {
	if ( creatingGeoZone == 1 ) {
		if ( creatingGeoPoints.length == 0 ) {
			var firstPoint = map.addMarker({
				lat: lat,
				lng: lng,
				icon: markerIcon('firstPoint'),
				optimized: false,
				animation: google.maps.Animation.DROP,
				infoWindow: {
					content: "<b>Clic aquí para finalizar creación de geozona.</b>"
				},
				mouseover: function() {
					this.infoWindow.open(this.map, this);
				},
				click: function() {
					/*
						FALTA SELECCIONAR TIPO DE GEOZONA
					*/
					swal({
						html: `
							<h2 style="color: #bdc3c7;">Nueva GeoZona</h2>
							<hr></hr>
							<input class="box-shadows" style='border-radius:3px; border: 1px solid #ecf0f1; padding: 0 12; text-align: center; width:80%; font-size:20px; height:40px;' id='newGeozoneName' type='text' placeholder="Nombre de la geozona">
						`,
						showCloseButton: true,
						showCancelButton: true,
						background: '#323232',
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Crear Geozona',
						cancelButtonText: 'Cancelar'
					}).then(function () {
						var newGeozoneName = $('#newGeozoneName').val();
						if( newGeozoneName.length > 2 ) {

							createGeoZone(newGeozoneName, 'secureZone', creatingGeoPoints);

						} else {
							toastr.warning('El nombre de la nueva geozona debe tener un mínimo de 3 caracteres.');
						}

					}, function (dismiss) {
						// dismiss can be 'cancel', 'overlay',
						// 'close', and 'timer'
						if (dismiss === 'cancel') {
							$('#createGeoZone').css('color', '#333333');
							creatingGeoZone = 0;
							creatingGeoPoints = [];
							map.setOptions({styles: style2});
							removeControl('controlCreatingGeoZone');
							mapObjectsRemover(objectsToRemove);

							toastr.warning('Creación de geozona cancelada.');

						} else if ( dismiss != 'cancel' ) {
							toastr.warning('Puede seguir creando la geozona.');
						}
					});

					$('#newGeozoneName').focus();
				}
			});
			
			objectsToRemove.push(firstPoint);
			creatingGeoPoints.push([lat, lng]);
		} else if ( creatingGeoPoints.length > 0 ) {
			creatingGeoPoints.push([lat, lng])

			var path = [
				[
					creatingGeoPoints[creatingGeoPoints.length-2][0], creatingGeoPoints[creatingGeoPoints.length-2][1]
				],
				[
					creatingGeoPoints[creatingGeoPoints.length-1][0], creatingGeoPoints[creatingGeoPoints.length-1][1]
				]
			];

			var creatingGeoPoly = map.drawPolyline({
				path: path,
				strokeColor: '#f1c40f',
				strokeOpacity: 0.6,
				strokeWeight: 6
			});

			objectsToRemove.push(creatingGeoPoly)	
		}
	}
}

/*
	Creador de Markers. ej: primer punto al crear geozona
*/
function markerIcon(type) {
	var iconSX = 24;
	var iconSY = 24;
	var iconURL = '';
	if (type == 'firstPoint') {
		iconURL = 'public/img/orangePoint.png'
	} 
	
	return {
		url: iconURL,
		scaledSize: new google.maps.Size(iconSX, iconSY),
		origin: new google.maps.Point(0, 0),
		anchor: new google.maps.Point(iconSX / 2, iconSY / 2)
	};
	
}

/*
	Centrar y/o hacer zoom dependiendo de las coordenadas y el numero de zoom
*/
function centerZoom(lat, lng, zoom) {
	if (zoom) {
		map.setCenter(lat, lng);
		map.setZoom(zoom);
	} else {
		map.setCenter(lat, lng);
	}
}

/*
	Flecha que representa los camiones
*/
function changeIcon(color, track) { // flecha con dirección y color
	var iconScale = 4;
	return {
		path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
		scale: iconScale,
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(iconScale / 2, iconScale / 2),
		rotation: parseInt(track),
		fillColor: color,
		fillOpacity: 1,
		strokeColor: color,
		strokeWeight: 1
	};
}

/*
	Redimensiona el alto del contenedor del mapa
*/
function resizeMapContainer() {
	setTimeout(function() {
		$('#map-container').css({
			'height': $(window).height()
		});
	}, 100);
}

/*
	Cargar todas las herramientas
*/
function loadToolsMenu() {
	var styleHidden = '';
	var styleCentered = '';
	var styleCreatingGeoZone = '';
	var lockButton = '';

	if( selectedPatent == '') {
		styleHidden = 'style="visibility:hidden; height:0px;" '
	}

	if ( centered == 1 ) {
		styleCentered = 'color: orange; '
	}

	if ( creatingGeoZone == 1 ) {
		styleCreatingGeoZone = 'style="color: #1abc9c"'
	}

	if (selectedLockStatus != '') {
		lockButton = selectedLockStatus;
	} else { 
		lockButton = `
			<center>
				<a style="width:100%; height:150px;" class="btn btn-default">
					<p style="color:#222222">Estado de la</p>
					<p style="color:#222222; margin-top:-15px;">cerradura</p>
					<i style="color:#2c3e50" class="fa fa-circle-o-notch fa-spin fa-4x fa-fw"></i>
				</a>
			</center>
		`
	}

	$('#toolsMenu').html(`
	<div>

		<!-- Nav tabs -->
		<ul class="nav nav-tabs" role="tablist">
			<li role="presentation" class="navTab active"><a href="#generalTools" aria-controls="generalTools" role="tab" data-toggle="tab">Herramientas Generales</a></li>
			<li ${styleHidden} class="navTab inPatentSelectionOnly" role="presentation"><a href="#truckTools" aria-controls="truckTools" role="tab" data-toggle="tab">Herramientas del camión</a></li>
			<li ${styleHidden} class="navTab inPatentSelectionOnly" role="presentation"><a href="#travelInfo" aria-controls="travelInfo" role="tab" data-toggle="tab">Información del viaje</a></li>
		</ul>

		<!-- Tab panes -->
		<div class="tab-content" style="padding:30px;">

			<div role="tabpanel" class="tab-pane active" id="generalTools">
				<div class="row">
					<div class="col-md-2 col-sm-3 col-xs-12">
						<select style="width: 100%; margin-top: -10px" id="search-patent"><option></option></select> 
						<select style="width: 100%; margin-top: -10px" id="search-geozone"><option></option></select>  
					</div>
					<div class="col-md-2 col-sm-3 col-xs-12">
						<center>
							<a id="createGeoZone" ${styleCreatingGeoZone} class="btn btn-default">
								<h4><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Crear Geozona</h4>
							</a>	
						</center>
					</div>

					<div style="background:#333435; border:1px solid #7f8c8d; padding:3px; border-radius:5px;" class="col-md-6 col-sm-3 col-xs-12">
						<center><h3 style="color:#bdc3c7; margin-top:-5px;">Estado de todas las cerraduras</h3></center>
						<center><div id="allLockStatus" style="width:100%;">${locks}</div></center>
						
					</div>

				</div>
			</div>

			<div role="tabpanel" class="tab-pane" id="truckTools">
				<div class="row">

					<div class="col-md-1 col-sm-2 col-xs-12">
						<div id="securityLockStatus" style="width: 100%; height: 150px;">
							${lockButton}
						</div>
					</div>

					<div class="col-md-1 col-sm-2 col-xs-12">
						<div id="latestDate" class="box-shadows" style="background: #2ecc71;width: 100%; height: 150px;"></div>
					</div>

					<div class="col-md-2 col-sm-4 col-xs-12">
						<center>
							<div id="container-speed" style="width: 100%; height: 150px;"></div>
						</center>
					</div>

					<div class="col-md-2 col-sm-4 col-xs-12">
						<center>
							<a id="centerTruck" style="margin-top:10px; ${styleCentered}" class="btn btn-default btn-block">
								<h4><i class="fa fa-circle-o" aria-hidden="true"></i> Centrar Camión</h4>
							</a>
							
							<a style="margin-top:10px;" class="btn btn-default btn-block">
								<h4><i class="fa fa-road" aria-hidden="true"></i> Vista panorámica</h4>
							</a>
						</center>
					</div>

				</div>
			</div>

		</div>

	</div>
	`);

	/* 
		Buscador de patentes
	*/
	$("#search-patent").select2({
		allowClear: true,
		placeholder: "Seleccione una patente",
		data: allPatentsSearch
	});
	
	/* 
		Buscador de geozonas
	*/
	$("#search-geozone").select2({
		allowClear: true,
		placeholder: "Seleccione una geozona",
		data: allGeozonesSearch
	});

	$('#toolsMenuButton').html('<i class="fa fa-angle-double-down fa-4x" aria-hidden="true"></i>');
	toolsMenu = 1;

	chargeGauge();
	//resizeMapContainer();
	getAllLockStatus();

	$('html, body').animate({
        scrollTop: $('#toolsMenu').offset().top
    }, 300);
}

/*
	Speed gauge
*/
function chargeGauge() {
	var gaugeOptions = {
	
		chart: {
			type: 'solidgauge'
		},
	
		title: null,
	
		pane: {
			center: ['50%', '85%'],
			size: '100%',
			startAngle: -90,
			endAngle: 90,
			background: {
				backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || '#EEE',
				innerRadius: '60%',
				outerRadius: '100%',
				shape: 'arc'
			}
		},
	
		tooltip: {
			enabled: false
		},
	
		// the value axis
		yAxis: {
			stops: [
				[0.1, '#55BF3B'], // green
				[0.5, '#DDDF0D'], // yellow
				[0.9, '#DF5353'] // red
			],
			lineWidth: 0,
			minorTickInterval: null,
			tickAmount: 2,
			title: {
				y: -70
			},
			labels: {
				y: 16
			}
		},
	
		plotOptions: {
			solidgauge: {
				dataLabels: {
					y: 5,
					borderWidth: 0,
					useHTML: true
				}
			}
		}
	};
	
	// The speed gauge
	chartSpeed = Highcharts.chart('container-speed', Highcharts.merge(gaugeOptions, {
		yAxis: {
			min: 0,
			max: 120,
			title: {
				text: 'Velocidad en tiempo real'
			}
		},

		credits: {
			enabled: false
		},

		series: [{
			name: 'Speed',
			data: [0],
			dataLabels: {
				format: '<div style="text-align:center"><span style="font-size:25px;color:' +
					((Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black') + '">{y}</span><br/>' +
					'<span style="font-size:12px;color:silver">km/h</span></div>'
			},
			tooltip: {
				valueSuffix: ' km/h'
			}
		}]
	}));
	
}

/*
	Manu de herramientas ( control de estados )
*/
function toolsMenuFunc() {
	if (toolsMenu == 0) {
		loadToolsMenu();
	} else if(toolsMenu == 1) {
		$('#toolsMenu').empty();
		$('#map-container').css({
			'height': $(window).height()
		});

		$('#toolsMenuButton').html('<i class="fa fa-angle-double-up fa-4x" aria-hidden="true"></i>');
		toolsMenu = 0;
	}
}

/*
	removedor de herramientas del mapa
*/
function removeControl(id) {
	var control = null;
	var allControls = map.controls;
	allControls.forEach( function ( element, index ) {
		if( element.id === id ) {
			control = element;
			map.removeControl(element)
		}
	});
}

/*
	removedor de objetos del mapa.
*/
function mapObjectsRemover(arr) { // remover del mapa los objetos del arreglo
	for (var i = 0; i < arr.length; i++) {
		arr[i].setMap(null);
	}
	objectsToRemove = [];
}

function selectGeozone(geozone_name, geozoneObj) {
	var inGeoPatents = '';

	markersAdd.forEach(function(element, index) {
		inGeoPatents += `<option id="opt${markersAdd[index]}" value="${markersAdd[index]}" >${markersAdd[index]}</option>`;
	});

	swal({
		html: `
		<h2 style="color:white;">${geozone_name}</h2>
		<h4 style="color:white;">Seleccionar patentes autorizadas</h4>
        <br>
		<select placeholder="Seleccione las patentes autorizadas" style="width:200px" id="multipleSelector" multiple="multiple">
			${inGeoPatents}
		</select>
		`,
		showCloseButton: true,
		showCancelButton: true,
		background: '#323232',
		confirmButtonColor: '#3085d6',
		cancelButtonColor: '#d33',
		confirmButtonText: 'Guardar',
		cancelButtonText: 'Eliminar Geozona'
	}).then(function () {
		var geoPatents = $('#multipleSelector').val();

		$.ajax({
			url: '/api/geozones/setGeozonePatents',
			type: 'POST',
			data: { name: geozone_name, patents: JSON.stringify(geoPatents) }
		})
		.done(function(data) {
			if (data.ok) {
				toastr.success('Geozona "'+geozone_name+'" Modificada correctamente');
			}
		})
		.fail(function() {
			console.log("error modificando geozona");
		});

	}, function (dismiss) {
		// dismiss can be 'cancel', 'overlay',
		// 'close', and 'timer'
		if (dismiss === 'cancel') {
			$.ajax({
				url: '/api/geozones/deleteGeo',
				type: 'POST',
				data: { name: geozone_name },
			})
			.done(function(data) {
				console.log(data);
				if (data.ok) {
					geozoneObj.setMap(null);
					toastr.success('Geozona "'+geozone_name+'" Eliminada correctamente');
				} else if (data.error) {
					toastr.warning('Error al eliminar geozona '+geozone_name);
				}
			})
			.fail(function() {
				console.log("error al eliminar geozona");
			});
		} else if ( dismiss != 'cancel' ) {
			
		}
	});

	$.ajax({
		url: '/api/geozones/patentsInGeo',
		type: 'POST',
		data: { name: geozone_name },
	})
	.done(function(data) {
		$('#multipleSelector').val(data).trigger('change');
	})
	.fail(function() {
		console.log("error al obtener patentes de geozona");
	});
	
	$('#multipleSelector').select2({});
}

/* INICIO EVENTOS */

$('#toolsMenu').on('click', '#centerTruck', function() { // centrar camión
	if (centered == 0) {
		centerZoom(trucksData[selectedPatent].lat, trucksData[selectedPatent].lng);	
		$('#centerTruck').css('color', 'orange');
		centered = 1;

		map.addControl({
			position: 'right_center',
			content: `<i style="color:orange" class="fa fa-circle-o fa-2x" aria-hidden="true"></i>`,
			id: 'controlCentered',
			style: {
				padding: '3px',
				height: '30px',
				width: '30px',
				backgroundColor: '#ecf0f1'
			}
		});

	} else if ( centered == 1) {
		$('#centerTruck').css('color', '#333333');
		centered = 0;
		removeControl('controlCentered')
	}
});

$('#toolsMenu').on('click', '#createGeoZone', function(e) {
	if(creatingGeoZone == 0) {
		creatingGeoZone = 1;
		$('#createGeoZone').css('color', '#1abc9c');
		map.setOptions({styles: style1});

		map.addControl({
			position: 'right_center',
			content: `<i style="color:#1abc9c" class="fa fa-pencil-square-o fa-2x" aria-hidden="true"></i>`,
			id: 'controlCreatingGeoZone',
			style: {
				padding: '3px',
				height: '30px',
				width: '30px',
				backgroundColor: '#ecf0f1'
			}
		});

	} else if( creatingGeoZone == 1) {
		$('#createGeoZone').css('color', '#333333');
		creatingGeoZone = 0;
		map.setOptions({styles: style2});
		removeControl('controlCreatingGeoZone');
		mapObjectsRemover(objectsToRemove);
		creatingGeoPoints = [];
	}
	
	console.log(creatingGeoZone);
});


$('#toolsMenu').on('click', 'a[data-toggle=tab]', function() {
	//resizeMapContainer();
	$('html, body').animate({
        scrollTop: $('#toolsMenu').offset().top
    }, 300);
});


$('#toolsMenu').on('click', '#securityLockStatus', function() {
	toastr.warning('Cambio manual de estado de cerradura deshabilitado');

	/*
	$('#securityLockStatus').html(`
		<a style="margin-left: 20px; margin-top:20px; width:100px;" class="btn btn-success"> 
			<i class="fa fa-lock fa-4x" style="color:#2c3e50" aria-hidden="true"></i>
		</a>
	`);
	*/
});

$('.menu-btn').on('click', function() {
	$('#toolsMenu').empty();
	$('#map-container').css({
		'height': $(window).height()
	});

	$('#toolsMenuButton').html('<i class="fa fa-angle-double-up fa-4x" aria-hidden="true"></i>');
	toolsMenu = 0;
});

$('#searchDirection').on('keypress', function(event) {
	if (event.keyCode == 13) {
		GMaps.geocode({
			address: $('#searchDirection').val(),
			callback: function(results, status) {
				if (status == 'OK') {
					var latlng = results[0].geometry.location;
					centerZoom(latlng.lat(), latlng.lng(), 15);
				}
			}
		});
	}
});

$('#searchDirectionButton').on('click', function(event) {
	GMaps.geocode({
		address: $('#searchDirection').val(),
		callback: function(results, status) {
			if (status == 'OK') {
				var latlng = results[0].geometry.location;
				centerZoom(latlng.lat(), latlng.lng(), 15);
			}
		}
	});
});

google.maps.event.addDomListener(window, "resize", function() { 
	resizeMapContainer();
});

$('#toolsMenu').on('select2:select', '#search-patent', function(e) {
	selectTruck(markersObj[e.params.data.text], trucksData[e.params.data.text]);
});

$('#toolsMenu').on('select2:select', '#search-geozone', function(e) {
	centerZoom(allGeozones[e.params.data.text].center[0], allGeozones[e.params.data.text].center[1], 17)
});


/* FIN EVENTOS */

</script>
{{/extend}}